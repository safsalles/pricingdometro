<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricind√¥metro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-purple-100 to-blue-100 min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-2xl text-purple-600">Carregando...</div>
        </div>
    </div>

    <script>
        // ========================================
        // üî• CONFIGURA√á√ÉO DO FIREBASE
        // ========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBoz5aVtL0tybvLlgZR9IyTL9BBCKN0G4s",
            authDomain: "pricingdometro.firebaseapp.com",
            databaseURL: "https://pricingdometro-default-rtdb.firebaseio.com",
            projectId: "pricingdometro",
            storageBucket: "pricingdometro.firebasestorage.app",
            messagingSenderId: "817331634651",
            appId: "1:817331634651:web:bee381491b296d609e67fe",
            measurementId: "G-TND7R7L9B0"
        };

        // ========================================
        // ‚öôÔ∏è CONFIGURA√á√ïES DO ADMIN
        // ========================================
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin123'; // MUDE ISSO!

        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        class Pricindometro {
            constructor() {
                this.currentUser = localStorage.getItem('currentUser') || null;
                this.isAdmin = false;
                this.users = [];
                this.emojisHistory = [];
                this.emojisToday = {};
                this.loading = true;

                this.init();
            }

            async init() {
                await this.checkDailyReset();
                await this.loadData();
                this.setupListeners();
                this.loading = false;
                this.render();
            }

            async checkDailyReset() {
                const today = this.getToday();
                const lastResetRef = database.ref('lastResetDate');
                
                const snapshot = await lastResetRef.once('value');
                const lastReset = snapshot.val();

                if (lastReset !== today) {
                    // Reseta os emojis de hoje
                    await database.ref('emojisToday').set({});
                    await lastResetRef.set(today);
                }
            }

            async loadData() {
                // Carrega usu√°rios
                const usersSnapshot = await database.ref('users').once('value');
                this.users = usersSnapshot.val() || [];

                // Carrega hist√≥rico
                const historySnapshot = await database.ref('emojisHistory').once('value');
                this.emojisHistory = historySnapshot.val() || [];

                // Carrega emojis de hoje
                const todaySnapshot = await database.ref('emojisToday').once('value');
                this.emojisToday = todaySnapshot.val() || {};
            }

            setupListeners() {
                // Escuta mudan√ßas em tempo real
                database.ref('users').on('value', (snapshot) => {
                    this.users = snapshot.val() || [];
                    if (!this.loading) this.render();
                });

                database.ref('emojisHistory').on('value', (snapshot) => {
                    this.emojisHistory = snapshot.val() || [];
                    if (!this.loading) this.render();
                });

                database.ref('emojisToday').on('value', (snapshot) => {
                    this.emojisToday = snapshot.val() || {};
                    if (!this.loading) this.render();
                });
            }

            getToday() {
                return new Date().toISOString().split('T')[0];
            }

            login(username, password = null) {
                if (username === ADMIN_USERNAME) {
                    if (password === ADMIN_PASSWORD) {
                        this.currentUser = username;
                        this.isAdmin = true;
                        localStorage.setItem('currentUser', username);
                        this.render();
                    } else {
                        alert('Senha incorreta!');
                    }
                } else if (this.users.includes(username)) {
                    this.currentUser = username;
                    this.isAdmin = false;
                    localStorage.setItem('currentUser', username);
                    this.render();
                } else {
                    alert('Usu√°rio n√£o encontrado! Pe√ßa ao admin pra te cadastrar.');
                }
            }

            logout() {
                this.currentUser = null;
                this.isAdmin = false;
                localStorage.removeItem('currentUser');
                this.render();
            }

            async addUser(username) {
                if (!username.trim()) return;
                if (username === ADMIN_USERNAME) {
                    alert('Este nome de usu√°rio √© reservado!');
                    return;
                }
                if (this.users.includes(username)) {
                    alert('Usu√°rio j√° existe!');
                    return;
                }
                
                const newUsers = [...this.users, username];
                await database.ref('users').set(newUsers);
                alert(`${username} foi adicionado com sucesso! ‚úÖ`);
            }

            async removeUser(username) {
                if (confirm(`Tem certeza que quer remover ${username}?\n\nIsso vai apagar todo o hist√≥rico de emojis dessa pessoa!`)) {
                    // Remove usu√°rio
                    const newUsers = this.users.filter(u => u !== username);
                    await database.ref('users').set(newUsers);

                    // Remove do hist√≥rico
                    const newHistory = this.emojisHistory.filter(e => 
                        e.to !== username
                    );
                    await database.ref('emojisHistory').set(newHistory);

                    // Remove de hoje
                    const newToday = {};
                    Object.keys(this.emojisToday).forEach(key => {
                        if (!key.includes(username)) {
                            newToday[key] = this.emojisToday[key];
                        }
                    });
                    await database.ref('emojisToday').set(newToday);
                }
            }

            async sendEmoji(recipient, emoji) {
                if (!emoji.trim()) return;

                const key = `${this.currentUser}->${recipient}`;
                
                if (this.emojisToday[key]) {
                    alert('Voc√™ j√° enviou um emoji pra essa pessoa hoje! Volta amanh√£ üòä');
                    return;
                }

                const today = this.getToday();
                
                // Salva no hist√≥rico de hoje
                const newToday = { ...this.emojisToday, [key]: emoji };
                await database.ref('emojisToday').set(newToday);

                // Salva no hist√≥rico completo (AN√îNIMO - ningu√©m v√™ quem enviou!)
                const newHistoryItem = {
                    from: "An√¥nimo",
                    to: recipient,
                    emoji: emoji,
                    date: today,
                    timestamp: Date.now()
                };
                const newHistory = [...this.emojisHistory, newHistoryItem];
                await database.ref('emojisHistory').set(newHistory);

                // Feedback visual
                const inputs = document.querySelectorAll('.emoji-input');
                inputs.forEach(input => {
                    if (input.dataset.recipient === recipient) {
                        input.value = '';
                        input.placeholder = '‚úì Enviado!';
                        setTimeout(() => {
                            input.placeholder = ':) ou xD ou ^^ ou (_*_) ...';
                        }, 2000);
                    }
                });
            }

            getReceivedEmojis(username) {
                return this.emojisHistory.filter(e => e.to === username);
            }

            getEmojisSentToday(recipient) {
                const key = `${this.currentUser}->${recipient}`;
                return this.emojisToday[key];
            }

            calculateScore(username) {
                return this.getReceivedEmojis(username).length;
            }

            getRanking() {
                return this.users
                    .map(user => ({
                        name: user,
                        score: this.calculateScore(user)
                    }))
                    .sort((a, b) => b.score - a.score);
            }

            getHistoryByDate() {
                const historyByDate = {};
                
                this.emojisHistory.forEach(item => {
                    if (!historyByDate[item.date]) {
                        historyByDate[item.date] = [];
                    }
                    historyByDate[item.date].push(item);
                });

                return Object.keys(historyByDate)
                    .sort()
                    .reverse()
                    .map(date => ({
                        date,
                        emojis: historyByDate[date]
                    }));
            }

            render() {
                const app = document.getElementById('app');
                
                if (this.loading) {
                    app.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center">
                            <div class="text-2xl text-purple-600">Carregando...</div>
                        </div>
                    `;
                    return;
                }
                
                if (!this.currentUser) {
                    app.innerHTML = this.renderLogin();
                } else if (this.isAdmin) {
                    app.innerHTML = this.renderAdmin();
                } else {
                    app.innerHTML = this.renderUser();
                }

                this.attachEventListeners();
            }

            renderLogin() {
                return `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">üíú</div>
                                <h1 class="text-4xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">
                                    Pricind√¥metro
                                </h1>
                                <p class="text-gray-600 mt-2">Espalhe amor e emojis! ‚ú®</p>
                            </div>

                            <div class="space-y-4">
                                <input
                                    type="text"
                                    id="loginUsername"
                                    placeholder="Seu nome de usu√°rio"
                                    class="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                />
                                
                                <input
                                    type="password"
                                    id="loginPassword"
                                    placeholder="Senha (s√≥ pra admin)"
                                    class="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                />

                                <button
                                    onclick="app.handleLogin()"
                                    class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all"
                                >
                                    Entrar
                                </button>
                            </div>

                            ${this.users.length > 0 ? `
                                <div class="mt-6 text-center text-sm text-gray-500">
                                    ${this.users.length} pessoa${this.users.length !== 1 ? 's' : ''} no Pricind√¥metro!
                                </div>
                            ` : ''}

                            <div class="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                                <p class="text-sm text-yellow-800">
                                    <strong>üë§ Usu√°rio comum:</strong> Digite seu nome (sem senha)<br>
                                    <strong>üëë Admin:</strong> Use "admin" + senha<br>
                                    <strong>üé≠ Emojis s√£o an√¥nimos!</strong> Ningu√©m v√™ quem enviou
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAdmin() {
                const ranking = this.getRanking();
                const history = this.getHistoryByDate();

                return `
                    <div class="max-w-7xl mx-auto p-4">
                        <!-- Header -->
                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 class="text-3xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">
                                        Pricind√¥metro - Admin üëë
                                    </h1>
                                    <p class="text-gray-600">Painel do Administrador</p>
                                </div>
                                <button
                                    onclick="app.logout()"
                                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors"
                                >
                                    Sair
                                </button>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-6 mb-6">
                            <!-- Gerenciar Usu√°rios -->
                            <div class="bg-white rounded-3xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">üë• Gerenciar Usu√°rios</h2>
                                
                                <div class="flex gap-2 mb-4">
                                    <input
                                        type="text"
                                        id="newUsername"
                                        placeholder="Nome do novo usu√°rio"
                                        class="flex-1 px-4 py-2 border-2 border-purple-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                    />
                                    <button
                                        onclick="app.handleAddUser()"
                                        class="px-6 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 font-semibold whitespace-nowrap"
                                    >
                                        + Adicionar
                                    </button>
                                </div>

                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${this.users.map(user => `
                                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                            <div>
                                                <span class="font-semibold">${user}</span>
                                                <span class="text-sm text-gray-500 ml-2">(${this.calculateScore(user)} emojis)</span>
                                            </div>
                                            <button
                                                onclick="app.removeUser('${user}')"
                                                class="px-3 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm"
                                            >
                                                Remover
                                            </button>
                                        </div>
                                    `).join('')}
                                    ${this.users.length === 0 ? `
                                        <div class="text-center text-gray-400 py-8">Nenhum usu√°rio cadastrado ainda</div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Ranking -->
                            <div class="bg-white rounded-3xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">üèÜ Ranking</h2>
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    ${ranking.map((user, index) => {
                                        const medals = ['ü•á', 'ü•à', 'ü•â'];
                                        return `
                                            <div class="p-4 rounded-xl bg-gradient-to-r from-purple-50 to-pink-50">
                                                <div class="flex justify-between items-center">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-2xl">${medals[index] || `${index + 1}¬∫`}</span>
                                                        <span class="font-semibold">${user.name}</span>
                                                    </div>
                                                    <span class="text-lg font-bold text-purple-600">${user.score} üíú</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                    ${ranking.length === 0 ? `
                                        <div class="text-center text-gray-400 py-8">Nenhum dado ainda</div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Hist√≥rico Completo -->
                        <div class="bg-white rounded-3xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìú Hist√≥rico Completo (An√¥nimo) üé≠</h2>
                            <div class="space-y-4 max-h-[500px] overflow-y-auto">
                                ${history.map(day => `
                                    <div class="border-l-4 border-purple-300 pl-4">
                                        <div class="font-bold text-purple-600 mb-2">${this.formatDate(day.date)}</div>
                                        <div class="space-y-1">
                                            ${day.emojis.map(e => `
                                                <div class="text-sm text-gray-700">
                                                    <span class="font-semibold">Algu√©m</span> 
                                                    enviou <span class="text-2xl mx-1">${e.emoji}</span> 
                                                    para <span class="font-semibold">${e.to}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                                ${history.length === 0 ? `
                                    <div class="text-center text-gray-400 py-8">Nenhum emoji enviado ainda</div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderUser() {
                const ranking = this.getRanking();
                const myEmojis = this.getReceivedEmojis(this.currentUser);

                return `
                    <div class="max-w-6xl mx-auto p-4">
                        <!-- Header -->
                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 class="text-3xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">
                                        Pricind√¥metro
                                    </h1>
                                    <p class="text-gray-600">Bem-vindo, ${this.currentUser}! üíú</p>
                                </div>
                                <button
                                    onclick="app.logout()"
                                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors"
                                >
                                    Sair
                                </button>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-6">
                            <!-- Enviar Emojis -->
                            <div class="bg-white rounded-3xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6">üíå Enviar Emojis</h2>
                                <p class="text-sm text-gray-500 mb-4">Voc√™ pode enviar 1 emoji por pessoa por dia! üé≠ <strong>Ningu√©m vai saber que foi voc√™!</strong></p>
                                <div class="space-y-4 max-h-[500px] overflow-y-auto">
                                    ${this.users.filter(u => u !== this.currentUser).map(user => {
                                        const sentToday = this.getEmojisSentToday(user);
                                        return `
                                            <div class="border-2 border-purple-100 rounded-xl p-4 hover:border-purple-300 transition-colors">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="font-semibold text-gray-800">${user}</span>
                                                    <span class="text-sm text-gray-500">
                                                        ${this.calculateScore(user)} emoji${this.calculateScore(user) !== 1 ? 's' : ''}
                                                    </span>
                                                </div>
                                                ${sentToday ? `
                                                    <div class="text-green-600 text-sm font-medium bg-green-50 p-2 rounded-lg">
                                                        ‚úì Enviado hoje: <span class="text-xl">${sentToday}</span>
                                                    </div>
                                                ` : `
                                                    <input
                                                        type="text"
                                                        placeholder=":) ou xD ou ^^ ou (_*_) ..."
                                                        class="emoji-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-sm"
                                                        data-recipient="${user}"
                                                    />
                                                `}
                                            </div>
                                        `;
                                    }).join('')}
                                    ${this.users.length === 1 ? `
                                        <div class="text-center text-gray-500 py-8">
                                            Voc√™ √© o √∫nico usu√°rio! Pe√ßa ao admin pra cadastrar mais pessoas! ü•∫
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Ranking -->
                            <div class="bg-white rounded-3xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6">üèÜ Ranking</h2>
                                <div class="space-y-3 max-h-[500px] overflow-y-auto">
                                    ${ranking.map((user, index) => {
                                        const medals = ['ü•á', 'ü•à', 'ü•â'];
                                        const receivedEmojis = this.getReceivedEmojis(user.name);
                                        const recentEmojis = receivedEmojis.slice(-5).reverse();

                                        return `
                                            <div class="p-4 rounded-xl ${
                                                user.name === this.currentUser 
                                                    ? 'bg-gradient-to-r from-purple-100 to-pink-100 border-2 border-purple-300' 
                                                    : 'bg-gray-50'
                                            }">
                                                <div class="flex justify-between items-center mb-2">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-2xl">${medals[index] || `${index + 1}¬∫`}</span>
                                                        <span class="font-semibold text-gray-800">${user.name}</span>
                                                        ${user.name === this.currentUser ? '<span class="text-xs bg-purple-200 px-2 py-1 rounded-full">Voc√™</span>' : ''}
                                                    </div>
                                                    <span class="text-lg font-bold text-purple-600">
                                                        ${user.score} üíú
                                                    </span>
                                                </div>
                                                ${recentEmojis.length > 0 ? `
                                                    <div class="text-sm text-gray-600">
                                                        √öltimos: ${recentEmojis.map(e => e.emoji).join(' ')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Meus Emojis Recebidos -->
                        <div class="bg-white rounded-3xl shadow-xl p-6 mt-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                                Meus Emojis Recebidos üíå (An√¥nimos üé≠)
                            </h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-96 overflow-y-auto">
                                ${myEmojis.slice().reverse().map(item => `
                                    <div class="bg-gradient-to-br from-pink-50 to-purple-50 p-3 rounded-xl text-center border border-purple-100">
                                        <div class="text-3xl mb-1">${item.emoji}</div>
                                        <div class="text-xs text-gray-600 font-medium">üíú</div>
                                        <div class="text-xs text-gray-400">${this.formatDate(item.date)}</div>
                                    </div>
                                `).join('')}
                                ${myEmojis.length === 0 ? `
                                    <div class="col-span-full text-center text-gray-400 py-8">
                                        Nenhum emoji recebido ainda... ü•∫<br>
                                        <span class="text-sm">Pe√ßa pros seus amigos te mandarem amor!</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            formatDate(dateStr) {
                const date = new Date(dateStr + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dateOnly = new Date(date);
                dateOnly.setHours(0, 0, 0, 0);

                const diffTime = today - dateOnly;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) return 'Hoje';
                if (diffDays === 1) return 'Ontem';
                if (diffDays < 7) return `H√° ${diffDays} dias`;
                
                return date.toLocaleDateString('pt-BR');
            }

            attachEventListeners() {
                // Login com Enter
                const loginUsername = document.getElementById('loginUsername');
                const loginPassword = document.getElementById('loginPassword');
                if (loginUsername) {
                    loginUsername.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleLogin();
                    });
                }
                if (loginPassword) {
                    loginPassword.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleLogin();
                    });
                }

                // Adicionar usu√°rio com Enter
                const newUsername = document.getElementById('newUsername');
                if (newUsername) {
                    newUsername.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleAddUser();
                    });
                }

                // Enviar emojis com Enter
                const emojiInputs = document.querySelectorAll('.emoji-input');
                emojiInputs.forEach(input => {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const recipient = input.dataset.recipient;
                            this.sendEmoji(recipient, input.value);
                        }
                    });
                });
            }

            handleLogin() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                if (username) {
                    this.login(username, password || null);
                }
            }

            handleAddUser() {
                const username = document.getElementById('newUsername').value.trim();
                if (username) {
                    this.addUser(username);
                    document.getElementById('newUsername').value = '';
                }
            }
        }

        // Inicializa o app quando o DOM estiver pronto
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new Pricindometro();
        });
    </script>
</body>
</html>
